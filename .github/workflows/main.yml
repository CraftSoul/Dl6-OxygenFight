name: Build Kivy Android APK and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

# 全局权限设置
permissions:
  contents: write
  actions: read
  checks: read

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
  CYTHON_LANGUAGE_LEVEL: "3"

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    # Job 级别权限设置
    permissions:
      contents: write  # 关键权限：允许创建 releases
      packages: read
      actions: write
      checks: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            git zip unzip \
            python3-pip autoconf automake libtool \
            pkg-config zlib1g-dev libncurses5-dev \
            libncursesw5-dev cmake libffi-dev libssl-dev \
            curl unzip openjdk-17-jdk
        sudo apt install -y libltdl-dev

    - name: Install Buildozer and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==0.29.33 kivy==2.2.1 plyer kivymd
        pip install python-for-android

    # ... 中间的构建步骤保持不变 ...

    - name: Create Release
      if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true' && github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        body: |
          Kivy Android APK 自动构建
          
          构建信息:
          - Commit: ${{ github.sha }}
          - 触发事件: ${{ github.event_name }}
          - 构建时间: ${{ steps.date.outputs.date }}
          - 构建工具: ${{ steps.buildozer-build.outputs.BUILD_METHOD == 'buildozer' && 'Buildozer' || steps.p4a-build.outputs.BUILD_METHOD == 'p4a' && 'Python-for-Android (p4a)' || steps.alt-build.outputs.BUILD_METHOD == 'alt' && 'Alternative Method' }}
          
          ${{ steps.buildozer-build.outputs.BUILD_METHOD == 'failed' && '注: 此版本使用备用方案构建。' || '' }}
        draft: false
        prerelease: false
        generate_release_notes: true  # 自动生成 release notes
      env:
        # 使用增强权限的 token
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          buildozer.log
          p4a.log
          clean.log
          update.log
        retention-days: 7
