name: Build Kivy Android APK and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
  CYTHON_LANGUAGE_LEVEL: "3"

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            git zip unzip \
            python3-pip autoconf automake libtool \
            pkg-config zlib1g-dev libncurses5-dev \
            libncursesw5-dev cmake libffi-dev libssl-dev \
            curl unzip openjdk-17-jdk
        sudo apt install -y libltdl-dev

    - name: Install Buildozer and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==0.29.33 kivy==2.2.1 plyer kivymd
        pip install python-for-android

    - name: Build APK with Buildozer (优化版本)
      id: buildozer-build
      continue-on-error: true
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        echo "=== 使用 Buildozer 构建 APK ==="
        java -version
        python --version
        buildozer --version
        
        # 设置环境变量解决网络问题
        export BUILDODER_ALLOW_PLATFORM_EXEC=1
        export USE_COLORS=0
        
        # 使用更稳定的构建命令
        buildozer -v android clean 2>&1 | tee clean.log
        buildozer -v android update 2>&1 | tee update.log
        
        # 设置 Gradle 选项
        export GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.java-home=$JAVA_HOME -Dorg.gradle.jvmargs=-Xmx2048m"
        
        # 构建 APK
        timeout 1800 buildozer -v android debug 2>&1 | tee buildozer.log
        
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "=== Buildozer 构建成功 ==="
          echo "BUILD_METHOD=buildozer" >> $GITHUB_OUTPUT
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "=== Buildozer 构建失败，将尝试修复方案 ==="
          echo "BUILD_METHOD=failed" >> $GITHUB_OUTPUT
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Build APK with p4a (修复版本)
      id: p4a-build
      if: steps.buildozer-build.outputs.BUILD_METHOD == 'failed'
      continue-on-error: true
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        echo "=== 使用修复的 p4a 构建 APK ==="
        java -version
        python --version
        
        # 清理之前的构建
        rm -rf .p4a_cache
        rm -rf ~/.p4a_cache
        rm -rf dist
        
        # 使用更新的 p4a 分支和配置
        pip install --upgrade python-for-android
        
        # 设置 p4a 配置避免 SDL2 编译错误
        export P4A_RELEASE_DIR="$(pwd)/dist"
        export P4A_BUILD_DIR="$(pwd)/.build"
        
        # 使用修复的构建命令 - 指定更新的 NDK 和 SDK
        p4a apk --private . \
          --package=org.test.craft.soul.dl6 \
          --name="DL6-OxygenFight" \
          --version=1.0 \
          --bootstrap=sdl2 \
          --requirements=python3,kivy==2.2.1,plyer,kivymd \
          --android-api=34 \
          --android-min-api=21 \
          --orientation=portrait \
          --window \
          --icon=image/inhalation.png \
          --presplash=image/title.png \
          --permission=INTERNET \
          --permission=WRITE_EXTERNAL_STORAGE \
          --permission=READ_EXTERNAL_STORAGE \
          --dist-name=dl6_oxygenfight \
          --arch=arm64-v8a \
          --arch=armeabi-v7a \
          --ndk-api=21 \
          --add-source=.
        
        if ls dist/dl6_oxygenfight/*.apk 1> /dev/null 2>&1; then
          echo "=== p4a 构建成功 ==="
          mkdir -p bin
          cp dist/dl6_oxygenfight/*.apk bin/
          echo "BUILD_METHOD=p4a" >> $GITHUB_OUTPUT
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "=== p4a 构建失败，尝试备用方法 ==="
          # 尝试使用 kivy 官方 bootstrap
          p4a apk --private . \
            --package=org.test.craft.soul.dl6 \
            --name="DL6-OxygenFight" \
            --version=1.0 \
            --bootstrap=webview \
            --requirements=python3,kivy==2.2.1,plyer,kivymd \
            --android-api=34 \
            --android-min-api=21 \
            --orientation=portrait \
            --permission=INTERNET
            
          if ls dist/*.apk 1> /dev/null 2>&1; then
            echo "=== 备用方法构建成功 ==="
            mkdir -p bin
            cp dist/*.apk bin/
            echo "BUILD_METHOD=p4a_webview" >> $GITHUB_OUTPUT
            echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
          else
            echo "=== 所有 p4a 方法都失败 ==="
            echo "BUILD_METHOD=failed" >> $GITHUB_OUTPUT
            echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi

    - name: Alternative build with fixed dependencies
      id: alt-build
      if: steps.p4a-build.outputs.BUILD_METHOD == 'failed'
      continue-on-error: true
      run: |
        echo "=== 使用替代构建方法 ==="
        
        # 安装固定版本的依赖
        pip install --upgrade pip
        pip install buildozer
        pip install kivy==2.2.1
        pip install kivymd
        pip install plyer
        
        # 使用固定版本的 p4a
        pip install python-for-android==2023.8.17
        
        # 简单的直接构建尝试
        python -m pythonforandroid.toolchain \
          create \
          --dist_name=dl6app \
          --bootstrap=sdl2 \
          --requirements=python3,kivy,plyer,kivymd \
          --arch=arm64-v8a \
          --arch=armeabi-v7a \
          --android-api=21 \
          --ndk-version=25b \
          --debug
        
        if [ -f dl6app/dist/dl6app/*.apk ]; then
          echo "=== 替代方法构建成功 ==="
          mkdir -p bin
          cp dl6app/dist/dl6app/*.apk bin/
          echo "BUILD_METHOD=alt" >> $GITHUB_OUTPUT
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "=== 替代方法构建失败 ==="
          echo "BUILD_METHOD=failed" >> $GITHUB_OUTPUT
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
        fi

    - name: Check build success
      id: check-build
      run: |
        if [ "${{ steps.buildozer-build.outputs.BUILD_SUCCESS }}" = "true" ] || [ "${{ steps.p4a-build.outputs.BUILD_SUCCESS }}" = "true" ] || [ "${{ steps.alt-build.outputs.BUILD_SUCCESS }}" = "true" ]; then
          echo "BUILD_FINAL_SUCCESS=true" >> $GITHUB_OUTPUT
          echo "=== 构建成功 ==="
        else
          echo "BUILD_FINAL_SUCCESS=false" >> $GITHUB_OUTPUT
          echo "=== 所有构建方法都失败了 ==="
        fi

    - name: Process and rename APK files
      if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true'
      run: |
        echo "=== 处理 APK 文件 ==="
        mkdir -p bin
        
        # 确保 APK 文件在 bin 目录
        find . -name "*.apk" -exec cp {} bin/ \; 2>/dev/null || true
        
        # 重命名 APK 文件
        if ls bin/*.apk 1> /dev/null 2>&1; then
          for apk in bin/*.apk; do
            if [ -n "${{ github.ref_type }}" ] && [ "${{ github.ref_type }}" = "tag" ]; then
              VERSION="${{ github.ref_name }}"
            else
              VERSION="$(git rev-parse --short HEAD)"
            fi
            
            BUILD_METHOD="${{ steps.buildozer-build.outputs.BUILD_METHOD }}${{ steps.p4a-build.outputs.BUILD_METHOD }}${{ steps.alt-build.outputs.BUILD_METHOD }}"
            NEW_NAME="DL6-OxygenFight-${VERSION}-${BUILD_METHOD}.apk"
            mv "$apk" "bin/${NEW_NAME}"
            echo "重命名为: ${NEW_NAME}"
          done
        fi
        
        echo "=== 最终 APK 文件 ==="
        ls -la bin/ 2>/dev/null || echo "没有找到 APK 文件"

    - name: Get current date
      if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true'
      id: date
      run: echo "date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Upload APK artifact
      if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: kivy-app-apk
        path: bin/*.apk
        retention-days: 30

    - name: Create Release
      if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true' && github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        body: |
          Kivy Android APK 自动构建
          
          构建信息:
          - Commit: ${{ github.sha }}
          - 触发事件: ${{ github.event_name }}
          - 构建时间: ${{ steps.date.outputs.date }}
          - 构建工具: ${{ steps.buildozer-build.outputs.BUILD_METHOD == 'buildozer' && 'Buildozer' || steps.p4a-build.outputs.BUILD_METHOD == 'p4a' && 'Python-for-Android (p4a)' || steps.alt-build.outputs.BUILD_METHOD == 'alt' && 'Alternative Method' }}
          
          ${{ steps.buildozer-build.outputs.BUILD_METHOD == 'failed' && '注: 此版本使用备用方案构建。' || '' }}
        draft: false
        prerelease: false

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          buildozer.log
          p4a.log
          clean.log
          update.log
        retention-days: 7
