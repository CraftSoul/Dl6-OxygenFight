name: Build Kivy Android APK

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            git zip unzip python3-pip autoconf automake libtool \
            pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev \
            cmake libffi-dev libssl-dev curl unzip openjdk-17-jdk libltdl-dev

    - name: Install Buildozer and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==0.29.33 kivy==2.2.1 plyer kivymd

    - name: Build APK with Buildozer
      id: build
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        echo "=== 构建 APK ==="
        
        # 设置环境变量
        export BUILDODER_ALLOW_PLATFORM_EXEC=1
        export USE_COLORS=0
        export GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.java-home=$JAVA_HOME"
        
        # 清理和构建
        buildozer -v android clean
        buildozer -v android debug 2>&1 | tee build.log
        
        # 检查构建结果
        if find . -name "*.apk" | grep -q .; then
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
          echo "=== 构建失败 ==="
          exit 1
        fi

    - name: Process APK files
      if: steps.build.outputs.BUILD_SUCCESS == 'true'
      run: |
        echo "=== 处理 APK 文件 ==="
        mkdir -p bin
        
        # 复制所有 APK 文件到 bin 目录
        find . -name "*.apk" -exec cp {} bin/ \;
        
        # 重命名 APK 文件
        for apk in bin/*.apk; do
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="$(git rev-parse --short HEAD)"
          fi
          
          NEW_NAME="DL6-OxygenFight-${VERSION}.apk"
          mv "$apk" "bin/${NEW_NAME}"
          echo "重命名为: ${NEW_NAME}"
        done
        
        echo "=== 最终文件 ==="
        ls -la bin/

    - name: Upload APK artifact
      if: steps.build.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 30

    - name: Create Release
      if: steps.build.outputs.BUILD_SUCCESS == 'true' && github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        body: |
          Kivy Android APK 自动构建
          
          构建信息:
          - Commit: ${{ github.sha }}
          - 版本: ${{ github.ref_name }}
          - 构建时间: $(date -u +'%Y-%m-%d %H:%M:%S')
        draft: false
        prerelease: false

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build.log
        retention-days: 7
