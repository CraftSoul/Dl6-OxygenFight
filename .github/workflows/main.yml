name: Build Kivy Android APK with p4a and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            git zip unzip \
            python3-pip autoconf automake libtool \
            pkg-config zlib1g-dev libncurses5-dev \
            libncursesw5-dev cmake libffi-dev libssl-dev \
            curl unzip openjdk-17-jdk
        sudo apt install -y libltdl-dev

    - name: Install Python-for-Android and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cython==0.29.33
        pip install kivy==2.2.1 plyer kivymd
        pip install python-for-android

    - name: Clean previous builds
      run: |
        rm -rf bin
        rm -rf .p4a_cache
        rm -rf ~/.p4a_cache

    - name: Build APK with p4a
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        echo "=== 环境信息 ==="
        java -version
        python --version
        p4a --version
        echo "=== 开始构建 APK ==="
        
        # 创建 p4a 构建命令
        p4a apk --private . \
          --package=org.test.craft.soul.dl6 \
          --name="DL6-OxygenFight" \
          --version=12.28 \
          --bootstrap=sdl2 \
          --requirements=python3,kivy==2.2.1,plyer,kivymd \
          --android-api=33 \
          --android-min-api=21 \
          --orientation=portrait \
          --window \
          --icon=image/inhalation.png \
          --presplash=image/title.png \
          --permission=INTERNET \
          --permission=WRITE_EXTERNAL_STORAGE \
          --permission=READ_EXTERNAL_STORAGE \
          --dist-name=dl6_oxygenfight \
          --arch=arm64-v8a \
          --arch=armeabi-v7a \
          --release \
          2>&1 | tee build.log

        if [ -f dist/dl6_oxygenfight/release/*.apk ]; then
          echo "=== 构建成功 ==="
          mkdir -p bin
          cp dist/dl6_oxygenfight/release/*.apk bin/
        else
          echo "=== 构建可能失败，检查日志 ==="
          find . -name "*.apk" -type f | head -10
        fi

      env:
        JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
        ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        ANDROID_HOME: /usr/local/lib/android/sdk
        CYTHON_LANGUAGE_LEVEL: "3"

    - name: Collect APK files
      if: always()
      run: |
        echo "=== 收集 APK 文件 ==="
        mkdir -p bin
        
        # 从多个可能的位置查找 APK
        find . -name "*.apk" -exec cp {} bin/ \; 2>/dev/null || true
        
        echo "=== 找到的 APK 文件 ==="
        ls -la bin/ 2>/dev/null || echo "没有找到 APK 文件"
        
        # 重命名 APK 文件以包含版本信息
        if ls bin/*.apk 1> /dev/null 2>&1; then
          for apk in bin/*.apk; do
            # 获取标签名，如果没有标签则使用 commit SHA
            if [ -n "${{ github.ref_type }}" ] && [ "${{ github.ref_type }}" = "tag" ]; then
              VERSION="${{ github.ref_name }}"
            else
              VERSION="$(git rev-parse --short HEAD)"
            fi
            NEW_NAME="DL6-OxygenFight-${VERSION}.apk"
            mv "$apk" "bin/${NEW_NAME}"
            echo "重命名为: ${NEW_NAME}"
          done
        fi

    - name: Get current date
      if: success() && github.ref_type == 'tag'
      id: date
      run: echo "date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kivy-app-apk-p4a
        path: bin/*.apk
        retention-days: 30

    - name: Create Release
      if: success() && github.ref_type == 'tag'
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        body: |
          Kivy Android APK 自动构建 (使用 p4a)
          
          构建信息:
          - Commit: ${{ github.sha }}
          - 触发事件: ${{ github.event_name }}
          - 构建时间: ${{ steps.date.outputs.date }}
          - 构建工具: Python-for-Android
        draft: false
        prerelease: false

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-p4a
        path: |
          build.log
        retention-days: 7
